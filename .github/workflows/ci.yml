name: CI (Continuous Integration)

# ëª¨ë“  pushì™€ Pull Requestì—ì„œ ìë™ ì‹¤í–‰
on:
  push:
    branches:
      - main
      - develop
      - 'claude/**'  # Claude ë¸Œëœì¹˜ë„ í¬í•¨
  pull_request:
    branches:
      - main
      - develop

# ë™ì‹œ ì‹¤í–‰ ì œì–´ (ê°™ì€ ë¸Œëœì¹˜ì—ì„œëŠ” ìµœì‹  ê²ƒë§Œ ì‹¤í–‰)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: ì½”ë“œ í’ˆì§ˆ ì²´í¬
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'  # pip ìºì‹œ í™œì„±í™”

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Check Python syntax
        run: |
          echo "Checking Python syntax..."
          python -m py_compile src/app.py
          python -m py_compile src/modules/ai_modules.py
          python -m py_compile src/modules/storage_manager.py
          echo "âœ… All Python files have valid syntax!"

      - name: ğŸ“Š Code statistics
        run: |
          echo "ğŸ“Š Code Statistics:"
          echo "-------------------"
          echo "Total Python files:"
          find . -name "*.py" | wc -l
          echo "Total lines of code:"
          find . -name "*.py" -exec wc -l {} + | tail -1
          echo "-------------------"

  # Job 2: Docker ì´ë¯¸ì§€ ë¹Œë“œ ê²€ì¦
  docker-build:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20  # 20ë¶„ ì œí•œ (ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦¬ë©´ ì‹¤íŒ¨)
    # Dockerfileì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰ (ì†ë„ í–¥ìƒ!)
    if: |
      contains(github.event.head_commit.message, '[docker]') ||
      contains(github.event.head_commit.message, 'docker:') ||
      github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build Docker image (validation only)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false  # ë¹Œë“œë§Œ í•˜ê³  pushëŠ” ì•ˆ í•¨
          tags: knu-chatbot:test
          # ìºì‹œ ì„¤ì • ìµœì í™” (ë¹Œë“œ ì†ë„ ê°œì„ )
          cache-from: type=gha
          cache-to: type=gha,mode=min  # ìµœì†Œ ìºì‹œë§Œ ì €ì¥ (ì†ë„ í–¥ìƒ!)
          # CIì—ì„œëŠ” ë¹ ë¥¸ í”¼ë“œë°±ì´ ì¤‘ìš”í•˜ë¯€ë¡œ ìºì‹œ í¬ê¸° ìµœì†Œí™”

      - name: âœ… Docker build successful
        run: |
          echo "âœ… Docker image built successfully!"
          echo "Image can be deployed safely."
          echo ""
          echo "Note: First build takes 10-15 minutes."
          echo "Subsequent builds will be faster with cache."

  # Job 3: í™˜ê²½ë³€ìˆ˜ ê²€ì¦
  env-validation:
    name: Environment Variables Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check .env.example exists
        run: |
          if [ -f ".env.example" ]; then
            echo "âœ… .env.example found"
            cat .env.example
          else
            echo "âŒ .env.example not found"
            exit 1
          fi

      - name: ğŸ” Check required files
        run: |
          echo "Checking required files..."
          files=(
            "requirements.txt"
            "Dockerfile"
            "docker-compose.yml"
            "src/app.py"
          )

          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file missing!"
              exit 1
            fi
          done

  # Job 4: ê²°ê³¼ ìš”ì•½
  ci-summary:
    name: CI Summary
    needs: [code-quality, docker-build, env-validation]
    runs-on: ubuntu-latest
    if: always()  # ì´ì „ jobì´ ì‹¤íŒ¨í•´ë„ ì‹¤í–‰

    steps:
      - name: ğŸ“Š Check results
        run: |
          echo "========================================="
          echo "ğŸ¯ CI Results Summary"
          echo "========================================="
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Docker Build: ${{ needs.docker-build.result }}"
          echo "Env Validation: ${{ needs.env-validation.result }}"
          echo "========================================="

          # Docker ë¹Œë“œê°€ ìŠ¤í‚µë˜ì—ˆëŠ”ì§€ í™•ì¸
          DOCKER_RESULT="${{ needs.docker-build.result }}"
          if [ "$DOCKER_RESULT" == "skipped" ]; then
            echo "â„¹ï¸  Docker build was skipped (not required for this commit)"
            DOCKER_RESULT="success"
          fi

          if [ "${{ needs.code-quality.result }}" == "success" ] && \
             [ "$DOCKER_RESULT" == "success" ] && \
             [ "${{ needs.env-validation.result }}" == "success" ]; then
            echo "âœ… All CI checks passed!"
            echo "Ready for deployment ğŸš€"
          else
            echo "âŒ Some CI checks failed"
            echo "Please fix the issues before deploying"
            exit 1
          fi

      - name: ğŸ’¬ Success message
        if: success()
        run: |
          echo "========================================="
          echo "ğŸ‰ CI Pipeline Completed Successfully!"
          echo "========================================="
          echo "Your code is ready to be deployed."
          echo ""
          echo "â„¹ï¸  Note: Docker build was skipped for faster CI."
          echo "To run Docker build, include '[docker]' in your commit message."
          echo ""
          echo "To deploy:"
          echo "  1. Go to Actions tab"
          echo "  2. Select 'CD (Deploy to AWS)' workflow"
          echo "  3. Click 'Run workflow'"
          echo "  4. Type 'deploy' and click 'Run workflow'"
          echo "========================================="
