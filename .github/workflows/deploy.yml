name: CD (Deploy to AWS)

# âš ï¸ ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ìˆ˜ë™ìœ¼ë¡œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤!
# ìë™ ë°°í¬ë¥¼ ì›í•˜ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”.
on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ì „ìš© (Actions íƒ­ì—ì„œ ë²„íŠ¼ í´ë¦­)
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      confirm:
        description: 'Type "deploy" to confirm'
        required: true
        default: ''

  # ìë™ ë°°í¬ë¥¼ ì›í•˜ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
  # push:
  #   branches:
  #     - main
  #   tags:
  #     - 'v*.*.*'  # v1.0.0 ê°™ì€ íƒœê·¸ì—ì„œë§Œ ë°°í¬

# í™˜ê²½ë³€ìˆ˜ ì •ì˜
env:
  APP_DIR: /opt/knu-chatbot  # EC2 ì„œë²„ì˜ ì•± ë””ë ‰í† ë¦¬

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest  # GitHub Actions ì‹¤í–‰ í™˜ê²½

    steps:
      # Step 0: ë°°í¬ í™•ì¸ (ì•ˆì „ì¥ì¹˜)
      - name: âš ï¸ Confirm deployment
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy" ]; then
            echo "========================================="
            echo "âŒ Deployment cancelled!"
            echo "========================================="
            echo "You must type 'deploy' to confirm deployment."
            echo "You typed: '${{ github.event.inputs.confirm }}'"
            exit 1
          fi

          echo "========================================="
          echo "âœ… Deployment confirmed!"
          echo "========================================="
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "========================================="

      # Step 1: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Step 2: SSH í‚¤ ì„¤ì •
      - name: ğŸ”‘ Setup SSH key
        run: |
          # SSH ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p ~/.ssh

          # SSH í‚¤ íŒŒì¼ ìƒì„± (GitHub Secretsì—ì„œ ê°€ì ¸ì˜´)
          echo "${{ secrets.AWS_EC2_SSH_KEY }}" > ~/.ssh/deploy_key

          # í‚¤ íŒŒì¼ ê¶Œí•œ ì„¤ì • (ë³´ì•ˆìƒ ì¤‘ìš”!)
          chmod 600 ~/.ssh/deploy_key

          # known_hostsì— ì„œë²„ ì¶”ê°€ (ì²˜ìŒ ì ‘ì† ì‹œ í™•ì¸ ê±´ë„ˆë›°ê¸°)
          ssh-keyscan -H ${{ secrets.AWS_EC2_HOST }} >> ~/.ssh/known_hosts

      # Step 3: EC2 ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
      - name: ğŸ”Œ Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.AWS_EC2_USERNAME }}@${{ secrets.AWS_EC2_HOST }} \
            "echo 'âœ… SSH connection successful'"

      # Step 4: ì„œë²„ì— ì½”ë“œ ë°°í¬
      - name: ğŸš€ Deploy to EC2
        run: |
          # EC2 ì„œë²„ì—ì„œ ì‹¤í–‰í•  ëª…ë ¹ì–´ë“¤
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.AWS_EC2_USERNAME }}@${{ secrets.AWS_EC2_HOST }} << 'ENDSSH'

          # ì‘ì—… ì‹œì‘ ë¡œê·¸
          echo "========================================="
          echo "ğŸš€ Starting deployment..."
          echo "Time: $(date)"
          echo "========================================="

          # ì•± ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (ì—†ìœ¼ë©´ ìƒì„±)
          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}

          # ê¸°ì¡´ ì½”ë“œ ë°±ì—… (ì•ˆì „ì¥ì¹˜)
          if [ -d "CHATBOT-AI" ]; then
            echo "ğŸ“¦ Backing up existing code..."
            mv CHATBOT-AI CHATBOT-AI.backup.$(date +%Y%m%d_%H%M%S) || true
          fi

          # GitHubì—ì„œ ìµœì‹  ì½”ë“œ í´ë¡ 
          echo "ğŸ“¥ Cloning latest code from GitHub..."
          git clone https://github.com/${{ github.repository }}.git

          cd CHATBOT-AI

          # .env íŒŒì¼ ìƒì„± (GitHub Secretsì—ì„œ í™˜ê²½ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸°)
          echo "ğŸ”§ Creating .env file..."
          cat > .env << 'EOF'
          # Upstage API
          UPSTAGE_API_KEY=${{ secrets.UPSTAGE_API_KEY }}

          # Pinecone
          PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }}

          # MongoDB (Docker Compose ë‚´ë¶€)
          MONGODB_URI=mongodb://mongodb:27017/

          # Redis (Docker Compose ë‚´ë¶€)
          REDIS_HOST=redis
          REDIS_PORT=6379

          # Flask
          FLASK_ENV=production
          EOF

          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
          echo "ğŸ›‘ Stopping existing containers..."
          docker compose -f docker-compose.prod.yml down || true

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ
          echo "ğŸ”¨ Building Docker images..."
          docker compose -f docker-compose.prod.yml build --no-cache

          # ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "â–¶ï¸  Starting containers..."
          docker compose -f docker-compose.prod.yml up -d

          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo ""
          echo "ğŸ“Š Container status:"
          docker compose -f docker-compose.prod.yml ps

          # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° (ì´ˆê¸° ì‹œì‘ ì‹œê°„)
          echo ""
          echo "â³ Waiting for containers to initialize..."
          sleep 45

          # í—¬ìŠ¤ì²´í¬ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
          echo ""
          echo "ğŸ” Running health checks..."
          MAX_RETRIES=10
          RETRY_INTERVAL=15
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."

            # Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            if ! docker ps | grep -q "knu-chatbot-app"; then
              echo "âš ï¸  App container is not running!"
              docker compose ps
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Waiting ${RETRY_INTERVAL}s before retry..."
                sleep $RETRY_INTERVAL
              fi
              continue
            fi

            # HTTP health check
            HEALTH_RESPONSE=$(curl -s http://localhost:5000/health || echo "")

            if echo "$HEALTH_RESPONSE" | grep -q '"status":"healthy"'; then
              echo "âœ… Health check passed!"
              echo "Response: $HEALTH_RESPONSE"
              break
            else
              echo "âš ï¸  Health check failed (response: '$HEALTH_RESPONSE')"
              RETRY_COUNT=$((RETRY_COUNT + 1))

              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Waiting ${RETRY_INTERVAL}s before retry..."
                sleep $RETRY_INTERVAL
              fi
            fi
          done

          # ìµœì¢… ì‹¤íŒ¨ ì²˜ë¦¬
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo ""
            echo "========================================="
            echo "âŒ Health check failed after $MAX_RETRIES attempts!"
            echo "========================================="
            echo ""
            echo "ğŸ“Š Container status:"
            docker compose -f docker-compose.prod.yml ps
            echo ""
            echo "ğŸ“‹ Application logs (last 100 lines):"
            docker logs knu-chatbot-app --tail 100
            echo ""
            echo "ğŸ“‹ MongoDB logs (last 50 lines):"
            docker logs knu-chatbot-mongodb --tail 50
            echo ""
            echo "ğŸ“‹ Redis logs (last 50 lines):"
            docker logs knu-chatbot-redis --tail 50
            echo "========================================="
            exit 1
          fi

          # ë°°í¬ ì™„ë£Œ
          echo ""
          echo "========================================="
          echo "âœ… Deployment completed successfully!"
          echo "Time: $(date)"
          echo "========================================="

          ENDSSH

      # Step 5: ë°°í¬ ê²°ê³¼ í™•ì¸
      - name: âœ… Verify deployment
        run: |
          # ì„œë²„ í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
          RESPONSE=$(curl -s http://${{ secrets.AWS_EC2_HOST }}:5000/health)
          echo "Health check response: $RESPONSE"

          # JSON ì‘ë‹µì—ì„œ status í•„ë“œ í™•ì¸
          if echo "$RESPONSE" | grep -q '"status":"healthy"'; then
            echo "âœ… Deployment verification successful!"
          else
            echo "âŒ Deployment verification failed!"
            exit 1
          fi

      # Step 6: ë°°í¬ ì„±ê³µ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      - name: ğŸ“¢ Deployment notification
        if: success()
        run: |
          echo "========================================="
          echo "ğŸ‰ Deployment Successful!"
          echo "========================================="
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Server: ${{ secrets.AWS_EC2_HOST }}"
          echo "========================================="
          echo "Access your app at:"
          echo "http://${{ secrets.AWS_EC2_HOST }}:5000"
          echo "========================================="

      # Step 7: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      - name: âŒ Deployment failed notification
        if: failure()
        run: |
          echo "========================================="
          echo "âŒ Deployment Failed!"
          echo "========================================="
          echo "Please check the logs above for details."
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "========================================="
